---
title: AFNetworking源码简析_1
layout: post
tags: []
category: 三方源码
---
本篇文章是AFNetworking部分源码的分析.主要从下面几个问题展开.

1. 原生的NSURLSession使用上有什么不便?

## NSURLSession的使用

* NSURL构造

```
NSURL *url = [NSURL URLWithString:@"xxx.com"];
```

* NSRequest构造

```
// 创建Request请求
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
    // 配置Request请求
    // 设置请求方法
    [request setHTTPMethod:@"GET"];
    // 设置请求超时 默认超时时间60s
    [request setTimeoutInterval:10.0];
    // 设置头部参数
    [request addValue:@"gzip" forHTTPHeaderField:@"Content-Encoding"];
    //或者下面这种方式 添加所有请求头信息
    request.allHTTPHeaderFields=@{@"Content-Encoding":@"gzip"};
    //设置缓存策略
    [request setCachePolicy:NSURLRequestReloadIgnoringLocalCacheData];
```

* 创建NSURLSession对象

```
NSURLSession *sharedSession = [NSURLSession sharedSession];

//可以通过NSURLSessionConfiguration来配置
 // 构造NSURLSessionConfiguration
    NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];
    // 构造NSURLSession，网络会话；
    NSURLSession *session = [NSURLSession sessionWithConfiguration:configuration];
```
configuration有三种类型
1. defaultSessionConfiguration: 默认配置, 会使用全局的缓存,cookie等.
2. ephemeralSessionConfiguration: 相当于浏览器的隐私模式, 不会对缓存或 cookie 以及认证信息进行存储.
3. backgroundSessionConfiguration: 应用切换到后台可继续工作.

* 创建NSURLSessionTask对象

task对象大致有四类
1. NSURLSessionDataTask  //一般的get、post等请求
2. NSURLSessionUploadTask // 用于上传文件或者数据量比较大的请求
3. NSURLSessionDownloadTask //用于下载文件或者数据量比较大的请求
4. NSURLSessionStreamTask //建立一个TCP / IP连接的主机名和端口或一个网络服务对象。

```
- (void)suspend;//暂停
- (void)resume;//开始或者恢复
- (void)cancel;//关闭任务
```

* 使用流程
```
 NSURL *URL = [NSURL URLWithString:@"http://example.com/upload"];
 NSURLRequest *request = [NSURLRequest requestWithURL:URL];
 NSData *data = ...;

 NSURLSession *session = [NSURLSession sharedSession];
 NSURLSessionUploadTask *uploadTask = [session uploadTaskWithRequest:request
                                                            fromData:data
                                                   completionHandler:
     ^(NSData *data, NSURLResponse *response, NSError *error) {
         // ...
     }];

 [uploadTask resume];
```

AFNetworking是在URLSession上进行的二次封装,那我们为啥没要舍弃原生的session,而引入一个三方网络框架呢?







参考链接:
[iOS网络请求之NSURLSession使用](http://www.cnblogs.com/whoislcj/p/6369717.html)