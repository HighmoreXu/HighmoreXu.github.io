---
categories: Uncategoried
category: iOS
layout: post
tags: []
title: Block学习_1
---
PreView

block简单来说就是[闭包](https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)在Objective-C中的实现.

闭包: 一个函数(或者指向函数的指针)加上自由变量(函数执行的外部的上下文变量)

## 预备知识

### block结构

```
struct Block_layout {  
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct Block_descriptor *descriptor;
    /* Imported variables. */
};

struct BlockDescriptor {
	unsigned long int reserved;
	unsigned long int size;
	void (*copy_helper)(void *dst, void *src);
	void (*dispose_helper)(void *src);
	const char *signature;
};
```

* isa指针,所有对象都有该指针,指向类.
* flags, 按bit标识block附加信息
* reserverd, 保留变量
* invoke, 函数指针,指向具体的block实现的函数调用地址.
* descriptor, block的附加描述信息. 主要是size大小, copy和dispose函数指针
* variables, 捕获过来的变量

后面用源码分析工具翻译的代码实际上和上面所说的结构没有差异,就是按照struct组织了一下.

### 研究工具
clang.命令行执行以下命令
`clang -rewrite-objc block.c`
block.c就是你需要翻译的文件名. 如果是main.m. 替换掉就好了.

### 类型
_NSConcreteGlobalBlock 全局的静态 block，不会访问任何外部变量。
_NSConcreteStackBlock 保存在栈中的 block，当函数返回时会被销毁。
_NSConcreteMallocBlock 保存在堆中的 block，当引用计数为 0 时会被销毁。

gc环境下还有三种. 暂时不研究了.

### 内存布局

![内存布局](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/memory_structure.jpg "内存布局")

### C语言变量类型

* 自动变量
* 函数参数
* 静态变量
* 静态全局变量
* 全局变量

## Block类型分析

### NSConcreteGlobalBlock

```
#import <Foundation/Foundation.h>

int main(int argc, const char * argv[]) {  
    void (^myBlock)(void) = ^{};
    NSLog(@"%@",myBlock);
    myBlock();
    return 0;
}
```
输出
```
<__NSGlobalBlock__: 0x100001058>  
```
使用clang改下和LLVM具体实现打印出来的结果实际上是不同的,这个不用太纠结.以LLVM为准.






参考链接:

>[谈Objective-C block的实现](https://blog.devtang.com/2013/07/28/a-look-inside-blocks/)
>[iOS 中的 block 是如何持有对象的](https://draveness.me/block-retain-object)
>[深入研究 Block 捕获外部变量和 __block 实现原理](https://halfrost.com/ios_block/)
>[_Block_object_assign](https://stackoverflow.com/questions/36993379/confusion-on-block-nsobject-obj-and-block-runtime)