---
title: Block学习_1
layout: post
tags: []
category: iOS
---
PreView

block简单来说就是[闭包](https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)在Objective-C中的实现.

闭包: 一个函数(或者指向函数的指针)加上自由变量(函数执行的外部的上下文变量)

### block的结构

```
struct BlockLiteral {
	void *isa;
	int flags;
	int reserved;
	void (*invoke)(void *, ...);
	struct BlockDescriptor *descriptor;
};

struct BlockDescriptor {
	unsigned long int reserved;
	unsigned long int size;
	void (*copy_helper)(void *dst, void *src);
	void (*dispose_helper)(void *src);
	const char *signature;
};
```

#### 类型
_NSConcreteGlobalBlock 全局的静态 block，不会访问任何外部变量。
_NSConcreteStackBlock 保存在栈中的 block，当函数返回时会被销毁。
_NSConcreteMallocBlock 保存在堆中的 block，当引用计数为 0 时会被销毁。

ARC环境下,NSConcreteStackBlock会被NSConcreteMallocBlock类型的block替代.


参考链接:

>[谈Objective-C block的实现](https://blog.devtang.com/2013/07/28/a-look-inside-blocks/)
>[iOS 中的 block 是如何持有对象的](https://draveness.me/block-retain-object)
>[深入研究 Block 捕获外部变量和 __block 实现原理](https://halfrost.com/ios_block/)