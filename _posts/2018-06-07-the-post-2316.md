---
category: iOS
layout: post
tags:
  - OCå†…å­˜å¸ƒå±€
title: 'Objective-C runtime - å±æ€§ä¸æ–¹æ³•'
---
## å‰è¨€

è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æOCä¸­çš„å±æ€§å’Œæ–¹æ³•.
æ–‡ç« ä¸»è¦æ€»ç»“å‚è€ƒé“¾æ¥ä¸­çš„å†…å®¹.
ç¯å¢ƒéƒ½æ˜¯x86_64æ¶æ„

## ç±»çš„ç»“æ„

![ç±»ç»“æ„](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/bits.png "ç±»ç»“æ„")

é€šè¿‡æŸ¥çœ‹æºä»£ç ,OCç±»çš„ç»„æˆåˆ†ä¸ºä¸Šå›¾å‡ ä¸ªéƒ¨åˆ†.

* isa æŒ‡å‘å…ƒç±»çš„æŒ‡é’ˆ
* super_class æŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»
* cache ç¼“å­˜æŒ‡é’ˆå’Œvatble,åŠ é€Ÿæ–¹æ³•è°ƒç”¨
* bits å­˜å‚¨ç±»çš„æ–¹æ³•,å±æ€§å’Œåè®®ç­‰ä¿¡æ¯

### class_data_bits_t

```
struct class_data_bits_t {
    uintptr_t bits;
    // method here
}
```
æˆå‘˜å˜é‡bitsç”¨äºå­˜å‚¨ä¸ç±»ç›¸å…³çš„ä¿¡æ¯

![class_bits](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/class_bits.png "class_bits")

```
#define FAST_IS_SWIFT           (1UL<<0)
#define FAST_HAS_DEFAULT_RR     (1UL<<1)
#define FAST_REQUIRES_RAW_ISA   (1UL<<2)
#define FAST_DATA_MASK          0x00007ffffffffff8UL
```
1. is_swift : åˆ¤æ–­æ˜¯å¦æ˜¯swiftç±»
2. has_default_rr: åˆ¤æ–­å½“å‰ç±»æˆ–è€…çˆ¶ç±»å«æœ‰é»˜è®¤çš„retain/release/autorelease/retainCount/_tryRetain/_isDeallocating/retainWeakReference/allowsWeakReference æ–¹æ³•
3. require_raw_isa : åˆ¤æ–­å½“å‰ç±»çš„å®ä¾‹æ˜¯å¦éœ€è¦raw_isa
4. data : ç¬¬4-48ä½ï¼Œå­˜æ”¾ä¸€ä¸ªæŒ‡å‘class_rw_tç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“åŒ…å«äº†è¯¥ç±»çš„å±æ€§ï¼Œæ–¹æ³•ï¼Œåè®®ç­‰ä¿¡æ¯

```
// objc_class ä¸­çš„ data() æ–¹æ³•
class_data_bits_t bits;

class_rw_t *data() { 
   return bits.data();
}

// class_data_bits_t ä¸­çš„ data() æ–¹æ³•
uintptr_t bits;

class_rw_t* data() {
   return (class_rw_t *)(bits & FAST_DATA_MASK);
```
ä¸Šè¯‰ä»£ç å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡º,ä¸»è¦çš„data()å†…å®¹å°±æ˜¯bitsçš„4-48ä½

#### class_rw_t å’Œ class_ro_t
```
struct class_rw_t {
    uint32_t flags;
    uint32_t version;

    const class_ro_t *ro;

    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    Class firstSubclass;
    Class nextSiblingClass;
};
```
é€šè¿‡å˜é‡å,æˆ‘ä»¬å¯ä»¥å¤§è‡´åˆ†æå‡º,Objcç±»çš„å±æ€§ã€æ–¹æ³•è¿˜æœ‰éµå¾ªçš„åè®®ç­‰ä¿¡æ¯éƒ½ä¿å­˜åœ¨class_rw_tä¸­.
æ³¨æ„è¿˜æœ‰ä¸ªæˆå‘˜å˜é‡class_ro_t.
```
struct class_ro_t {
    uint32_t flags;
    uint32_t instanceStart;
    uint32_t instanceSize;
    uint32_t reserved;
    const uint8_t * ivarLayout;
    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;
};
```
ğŸ¤”ï¸è¿™ä¸ªç»“æ„ä½“åˆæœ‰ä»€ä¹ˆç”¨å‘¢? å˜é‡åé‡Œä¸ºä»€ä¹ˆåˆå‡ºç°äº†å±æ€§ã€åè®®ã€æ–¹æ³•å‘¢?

å¤§ç¥ä»¬çš„æ–‡ç« è¿˜æœ‰ä¾‹å­å·²ç»å¾ˆè¯¦ç»†äº†.
è¿™è¾¹ç®€å•æ¬ä¸€ä¸‹ç»“è®º.

class_ro_t å­˜å‚¨çš„æ˜¯å½“å‰ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šçš„å±æ€§ã€åè®®ã€æ–¹æ³•ç­‰.

![before_resize](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/objc-method-before-realize.png "before_resize")

ç¼–è¯‘æœŸ, class_data_bits_t *dataæŒ‡å‘çš„æ˜¯ä¸€ä¸ªclass_ro_t *æŒ‡é’ˆ.

```
const class_ro_t *ro = (const class_ro_t *)cls->data();
class_rw_t *rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1);
rw->ro = ro;
rw->flags = RW_REALIZED|RW_REALIZING;
cls->setData(rw);
```
resizeä¹‹å,ç±»æ‰€å ç”¨çš„å†…å­˜å¸ƒå±€å‘ç”Ÿæ”¹å˜.
![resizeclass](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/objc-method-after-realize-class.png "resizeclass")

ç»†èŠ‚:
1. 
