---
layout: post
tags: []
title: 'Objective-C runtime - category'
category: Uncategoried
---
# å‰è¨€

é€šè¿‡å‰é¢çš„æ–‡ç« æˆ‘ä»¬å·²ç»å¯¹OCçš„ç±»ç»“æ„æœ‰äº†å¤§è‡´çš„äº†è§£.
æœ¬ç¯‡æ–‡ç« ä¸»è¦åŸºäºOCçš„ç±»æ¥æ¢ç©¶ä¸€ä¸‹åˆ†ç±»çš„å®ç°æœºåˆ¶.

## Category ç»“æ„
```
struct category_t {
    const char *name;
    classref_t cls;
    struct method_list_t *instanceMethods;
    struct method_list_t *classMethods;
    struct protocol_list_t *protocols;
    struct property_list_t *instanceProperties;
}; 
```

### methodæ·»åŠ 
categoryæˆ‘ä»¬å¸¸ç”¨çš„ç”¨æ³•å°±æ˜¯ä¸ºç°æœ‰çš„ç±»æ‰©å±•æ–¹æ³•,å› æ­¤æˆ‘ä»¬ä»method_list_tå¼€å§‹åˆ†æ.

```
struct method_list_t : entsize_list_tt<method_t, method_list_t, 0x3> {
    // æˆå‘˜å˜é‡å’Œæ–¹æ³•
};

template <typename Element, typename List, uint32_t FlagMask>
struct entsize_list_tt {
    uint32_t entsizeAndFlags;
    uint32_t count;
    Element first;
};
```
ç®€å•æ¥è¯´,method_list_tå°±æ˜¯ç®¡ç†method_tçš„å®¹å™¨
```
struct method_t {
    SEL name;   // æ–¹æ³•åç±»å‹,ç›¸åŒåå­—çš„æ–¹æ³•å³ä½¿åœ¨ä¸åŒçš„ç±»ä¸­ä¹Ÿç›¸åŒ
    const char *types;  // æ–¹æ³•ç±»å‹,å­˜å‚¨æ–¹æ³•å‚æ•°ç±»å‹å’Œè¿”å›å€¼ 
    IMP imp; // æ–¹æ³•çš„å…·ä½“å®ç°
};
```

å­˜å‚¨æ‰€æœ‰categoryçš„ç»“æ„ä½“category_list
```
struct locstamped_category_list_t {
    uint32_t count;
    locstamped_category_t list[0];
};
struct locstamped_category_t {
    category_t *cat;
    struct header_info *hi;
};
typedef locstamped_category_list_t category_list;
```


#### æ·»åŠ åˆ†ç±»æ–¹æ³•çš„æµç¨‹
objc_init -> read_images -> remethodizeClass -> attachCategorys

æˆ‘ä»¬ç›®å‰å…³æ³¨çš„æ˜¯å¦‚ä½•æ·»åŠ åˆ†ç±»æ–¹æ³•,å› æ­¤ç›´æ¥çœ‹attachCategorysçš„å®ç°.
```
static void attachCategories(Class cls, category_list *cats, bool flush_caches) {
    if (!cats) return;
    bool isMeta = cls->isMetaClass();

    method_list_t **mlists = (method_list_t **)malloc(cats->count * sizeof(*mlists));
    // Count backwards through cats to get newest categories first
    int mcount = 0;
    int i = cats->count;
    while (i--) {
        auto& entry = cats->list[i];

        method_list_t *mlist = entry.cat->methodsForMeta(isMeta);
        if (mlist) {
            mlists[mcount++] = mlist;
        }
    }

    auto rw = cls->data();

    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);
    rw->methods.attachLists(mlists, mcount);
    free(mlists);
    if (flush_caches  &&  mcount > 0) flushCaches(cls);
}
```
è¿™é‡Œåªä¿ç•™äº†å’Œæ–¹æ³•ç›¸å…³çš„å®ç°.æ•´ä¸ªæµç¨‹ä¹Ÿæ¯”è¾ƒç®€å•.
1. åˆ›å»ºä¸€ä¸ªå­˜å‚¨method_list_tçš„æŒ‡é’ˆæ•°ç»„. mlistsæŒ‡å‘è¯¥æŒ‡é’ˆæ•°ç»„çš„èµ·å§‹åœ°å€.
2. éå†category_list,å³è¯¥ç±»çš„æ‰€æœ‰æ‰©å±•.æ¯ä¸€ä¸ªåˆ†ç±»çš„æ–¹æ³•åˆ—è¡¨éƒ½ä¾æ¬¡åŠ åˆ°æŒ‡é’ˆæ•°ç»„ä¸­.
3. class_rw_tè¿›è¡ŒattachListsçš„æ“ä½œ.

å‰ä¸¤æ­¥éƒ½æ¯”è¾ƒå¥½ç†è§£,é‚£ç¬¬ä¸‰æ­¥å…·ä½“åšäº†å“ªäº›äº‹æƒ…å‘¢?
ä¹‹å‰æˆ‘ä»¬å·²ç»äº†è§£äº†OCç±»å¤§è‡´ç»“æ„.class_rw_tä¸­åŒ…å«äº†method_array_tçš„æˆå‘˜å˜é‡.
```
template <typename Element, typename List>{
    struct array_t {
        uint32_t count;
        List* lists[0];
    };
}
class method_array_t : public list_array_tt<method_t, method_list_t>
```
listsæ•°ç»„å­˜å‚¨Listç±»å‹çš„æŒ‡é’ˆåˆ—è¡¨.
```
void attachLists(List* const * addedLists, uint32_t addedCount) {
    if (addedCount == 0) return;
    uint32_t oldCount = array()->count;
    uint32_t newCount = oldCount + addedCount;
    setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));
    array()->count = newCount;
    memmove(array()->lists + addedCount, array()->lists, oldCount * sizeof(array()->lists[0]));
    memcpy(array()->lists, addedLists, addedCount * sizeof(array()->lists[0]));
}
```
reallocé‡æ–°æ‰©å±•ç©ºé—´.æŠŠåŸæ¥çš„æ•°ç»„å¤åˆ¶åˆ°åé¢,æŠŠæ–°æ•°ç»„å¤åˆ¶åˆ°å‰é¢.
å› æ­¤,å¦‚æœæ·»åŠ çš„åˆ†ç±»æ–¹æ³•å’ŒåŸæœ‰ç±»é‡å¤,åˆ™ç›¸å½“äºå˜ç›¸"æ›¿æ¢"æ‰äº†åŸæœ‰çš„æ–¹æ³•.ä¸”æœ€åæ·»åŠ çš„åˆ†ç±»æ–¹æ³•æœ€å…ˆç”Ÿæ•ˆ.


[åŠ¨æ€æ·»åŠ æ–¹æ³•çš„ä¾‹å­](http://vanney9.com/2017/06/07/objective-c-runtime-category/)
ä¸Šé¢çš„é“¾æ¥æœ‰å¯¹åˆ†ç±»åŠ¨æ€æ·»åŠ æ–¹æ³•åšåˆ†æ.å…¶ä¸­æœ‰æ¡ç»“è®ºå’Œæˆ‘ä¹‹å‰æƒ³è±¡çš„ä¸ä¸€æ ·:
å¯¹äºç³»ç»Ÿè‡ªå¸¦çš„ç±»ï¼Œæ‰ä¼šåœ¨runtimeæ—¶åŠ è½½åˆ†ç±»ï¼›ä½†æ˜¯å¯¹äºè‡ªå·±åˆ›å»ºçš„ç±»ï¼Œåœ¨ç¼–è¯‘ç»“æŸä¹‹åå°±ç›´æ¥å°†åˆ†ç±»çš„æ–¹æ³•æ·»åŠ åˆ°baseMethodListä¸­äº†ï¼Œå°±å¥½åƒæ²¡æœ‰åˆ†ç±»ä¸€è¯´

### å±æ€§æ·»åŠ 
 ç†Ÿæ‚‰iOSå¼€å‘éƒ½çŸ¥é“,categoryæ˜¯æ— æ³•ç›´æ¥åƒæ·»åŠ æ–¹æ³•ä¸€æ ·æ·»åŠ å±æ€§çš„.
 
 #### å±æ€§å’Œå®ä¾‹å˜é‡
 ä¹‹å‰çš„æ–‡ç« åˆ—ä¸¾è¿‡class_rw_tå’Œclass_ro_tçš„å…·ä½“æ„æˆ.å…¶ä¸­å¯ä»¥å‘ç°å®ä¾‹å˜é‡åˆ—è¡¨ivarså­˜æ”¾åœ¨class_ro_tä¸­.
ğŸ¤”ï¸é‚£å±æ€§å’Œå®ä¾‹å˜é‡é—´åˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»å‘¢?
æŒ‰ç…§æˆ‘ä¸ªäººçš„ç†è§£,å±æ€§æœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯å®ä¾‹å˜é‡.åªä¸è¿‡ä¸ºå…¶ç”Ÿæˆäº†setterå’Œgetteræ–¹æ³•,æ›´å¥½çš„ç®¡ç†å†…å­˜è¯­ä¹‰.
è€Œroä»£è¡¨readonly,é‚£runtimeæ—¶æœŸå°±æ— æ³•åŠ¨æ€æ”¹å˜å…¶å†…å­˜ç»“æ„. è¿™æ ·ä¹Ÿæ˜¯åˆç†çš„.å› ä¸ºåœ¨ä½¿ç”¨åˆ†ç±»ä¹‹å‰,ä»¥è¯¥ç±»å¯¹è±¡ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡åœ¨å†…å­˜é‡Œé¢éƒ½åˆ†é…å¥½ç©ºé—´äº†,å¦‚æœæ·»åŠ äº†åˆ†ç±»ä¸”å…è®¸æ·»åŠ å®ä¾‹å˜é‡,é‚£ä¹ˆæ¯ä¸ªå¯¹è±¡çš„å†…å­˜ç»“æ„åœ¨å¼•å…¥åˆ†ç±»åéƒ½éœ€è¦æ”¹å˜.è¿™ä¸ªå¼€é”€æ˜¯å·¨å¤§çš„. è€Œä¹‹å‰è¯´è¿‡,å¯¹è±¡çš„æ–¹æ³•æ˜¯å­˜åœ¨ä¸ç±»å¯¹è±¡é‡Œé¢çš„,æ‰€ä»¥å¦‚æœé€šè¿‡åˆ†ç±»æ·»åŠ æ–¹æ³•,é‚£ä¹ˆæ‰€å½±å“çš„ä¹Ÿåªæ˜¯ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„,è¿™æ˜¯æ²¡æœ‰é—®é¢˜çš„,å› ä¸ºåªæœ‰ä¸€ä»½.

```
struct property_t {
    const char *name;
    const char *attributes;
};

struct ivar_t {
    int32_t *offset;
    const char *name;
    const char *type;
    // alignment is sometimes -1; use alignment() instead
    uint32_t alignment_raw;
    uint32_t size;

    uint32_t alignment() const {
        if (alignment_raw == ~(uint32_t)0) return 1U << WORD_SHIFT;
        return 1 << alignment_raw;
    }
};
```
[å±æ€§å˜é‡](http://vanney9.com/2017/06/05/objective-c-runtime-property-method/)
ä¸Šè¯‰æ–‡ç« æœ‰å¯¹å±æ€§å’Œå˜é‡çš„ä¾‹å­åˆ†æ,å¯ä»¥çœ‹ä¸‹

ä»æºç æ‰€ç¤ºçš„ç»“æ„æ¥çœ‹,çœŸæ­£æœ‰ç”¨çš„éƒ¨åˆ†è¿˜æ˜¯ivar_t.

####  å¦‚ä½•ç»™åˆ†ç±»æ·»åŠ å±æ€§
é€šè¿‡ä¸Šé¢çš„åˆ†æ,æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸èƒ½ç›´æ¥é€šè¿‡åˆ†ç±»æ·»åŠ å±æ€§çš„åŸå› æ˜¯å› ä¸ºæ·»åŠ å±æ€§çš„æœ¬è´¨æ˜¯æ·»åŠ å®ä¾‹å˜é‡, è€Œæ·»åŠ å®ä¾‹å˜é‡çš„æˆæœ¬è¿‡é«˜.é‚£çœŸçš„æ²¡æœ‰åŠæ³•äº†å—?ğŸ¤”ï¸

##### å…³è”å¯¹è±¡

[å…³è”å¯¹è±¡çš„åˆ†æ](https://github.com/Draveness/analyze/blob/master/contents/objc/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%20AssociatedObject%20%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90.md)
ä¸Šè¯‰æ–‡ç« å·²ç»å†™å¾—éå¸¸å¥½äº†,è¿™é‡Œå°±ä¸èµ˜è¿°äº†,å°±å¥—ç”¨ä¸‹åŸºæœ¬ç»“è®º.

![å…³è”å¯¹è±¡](https://raw.githubusercontent.com/HighmoreXu/BlogImage/master/images/objc-ao-associateobjcect.png "å…³è”å¯¹è±¡")

æ€»æ€è·¯å°±æ˜¯è®©å¯¹è±¡å’Œå±æ€§ä¹‹é—´èƒ½æœ‰å¯¹åº”å…³ç³».

1. å•ä¾‹å¯¹è±¡AssociationsManagerè´Ÿè´£å­˜å‚¨æ‰€æœ‰çš„å…³è”å¯¹è±¡.
2. å­˜å‚¨çš„æ•°æ®ç»“æ„é‡‡ç”¨AssociationsHashMap. keyä¸ºå¯¹è±¡çš„åœ°å€, valueä¸ºObjectAssociationMap
3. ObjectAssociationMapä¸ªäººè§‰å¾—å¯ä»¥ç†è§£ä¸ºå…³è”å¯¹è±¡.keyä¸ºå±æ€§åç§°(void *key),valueä¸ºObjcAssociation.
4. ObjcAssociationå°±æ˜¯å®é™…å­˜å‚¨çš„å†…å®¹,åŒ…æ‹¬_policyå†…å­˜ç®¡ç†è¯­ä¹‰å’Œ_Valueå±æ€§çš„å€¼.
5. æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ ‡è®°ä½ has_assoc æŒ‡ç¤ºå¯¹è±¡æ˜¯å¦å«æœ‰å…³è”å¯¹è±¡

```
void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy);
id objc_getAssociatedObject(id object, const void *key);
void objc_removeAssociatedObjects(id object);
```
ç†è§£ç®¡ç†å¯¹è±¡çš„ç®¡ç†æ–¹å¼ä»¥å,APIä¹Ÿæ¯”è¾ƒæ˜äº†äº†,éœ€è¦ä¼ å…¥object(å¯¹è±¡çš„åœ°å€), key(å±æ€§åç§°), value(å…·ä½“çš„å­˜å‚¨å†…å®¹), policy(å†…å­˜ç®¡ç†è¯­ä¹‰)






