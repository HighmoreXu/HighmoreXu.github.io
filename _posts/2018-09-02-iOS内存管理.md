---
title: iOS内存管理
layout: post
tags: []
category: iOS
---
## 前言

本篇文章主要总结下iOS平台对内存的管理.
主要内容来自segment fault的视频分享,可以考虑先观看视频.

## 虚拟内存与物理内存

### 虚拟内存是什么?

> 虚拟内存是计算机系统内存管理的一种技术。它使得应用程序认为它拥有连续可用的内存（一个连续完整的地址空间），而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，在需要时进行数据交换。与没有使用虚拟内存技术的系统相比，使用这种技术的系统使得大型程序的编写变得更容易，对真正的物理内存（例如RAM）的使用也更有效率。

直接管理物理内存存在的问题:
1. 进程地址空间不能隔离
2. 内存使用率低
3. 程序运行的地址不能确定

虚拟内存就是在我们程序和内存之间建立了一个中间层,来解决上诉直接管理内存存在的问题.

### iOS下虚拟内存的应用

iOS下内存分为两种类型: clean memory, dirty memory.
* clean memory: 在闪存中有备份,能够再次读取. 主要包括代码, 框架, 内存映射文件.
* dirty memory: 所有非clean memory. 包括Heap allocation、caches、decompressed images.

虚拟内存 = clean memory + dirty memory

举个例子看两种类型内存:
```
// clean memory
char *buf = malloc(100*1024*1024)

// dirty memory
for(int i=0; i < 3*1024*1024; ++i){
    buf[i] = rand()
}
```
第一段malloc代码,申请了100M的内存, 但是操作系统并不会真的就分配100M物理内存,而只是会分配100M的clean momory.
当执行for循环以后,有3M的内存变为了dirty memory.与此同时,物理内存也会真正被分配3M来存放buf的内容.

我们可以进一步得出结论:
物理内存(resident memory) = dirty memory + clean momory that loaded in physical memory







## 引用

[虚拟内存的由来](https://blog.csdn.net/m0_37806112/article/details/81104972)
[内存管理及优化视频](https://www.imooc.com/video/11075)
[先弄清楚这里的学问，再来谈 iOS 内存管理与优化](https://www.jianshu.com/p/deab6550553a)